<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>نظام المهندس أشرف عادل - النسخة الاحترافية</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-hover: #3a56d4;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --dark: #1b263b;
      --darker: #0d1b2a;
      --light: #e0e1dd;
      --light-text: #f8fafc;
      --border: #1e293b;
      --message-user: #4361ee;
      --message-bot: #334155;
      --typing-indicator: #10b981;
      --file-color: #8b5cf6;
      --sidebar-width: 300px;
      --online-status: #10b981;
      --camera-color: #ef4444;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #f72585;
      --border-radius: 12px;
      --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      --header-height: 70px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--darker), var(--dark));
      color: var(--light-text);
      height: 100vh;
      display: flex;
      transition: all 0.3s ease;
    }
    
    body.light-mode {
      --dark: #e0e1dd;
      --darker: #caf0f8;
      --light-text: #1b263b;
      --message-bot: #e0e1dd;
      --border: #778da9;
    }
    
    .sidebar {
      width: var(--sidebar-width);
      background: var(--dark);
      border-left: 1px solid var(--border);
      padding: 15px;
      overflow-y: auto;
      transition: transform 0.2s ease;
      z-index: 1000;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .sidebar-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .close-sidebar {
      background: none;
      border: none;
      color: var(--light-text);
      font-size: 18px;
      cursor: pointer;
    }
    
    .api-key-item {
      padding: 10px;
      margin-bottom: 10px;
      background: var(--darker);
      border-radius: var(--border-radius);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .api-key-item:hover {
      background: var(--primary);
      transform: translateY(-2px);
    }
    
    .api-key-item.active {
      background: var(--primary);
      border-color: var(--primary);
      box-shadow: var(--box-shadow);
    }
    
    .api-key-item.error {
      background: #7f1d1d;
      border-color: #ef4444;
    }
    
    .api-key-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .api-key-number {
      font-weight: bold;
    }
    
    .api-key-status {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--success);
    }
    
    .api-key-status.error {
      background: var(--danger);
    }
    
    .api-key-value {
      font-size: 12px;
      word-break: break-all;
      opacity: 0.7;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    header {
      background: var(--dark);
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      height: var(--header-height);
      box-shadow: var(--box-shadow);
      z-index: 100;
    }
    
    .header-info {
      display: flex;
      align-items: center;
      position: relative;
    }
    
    header img {
      width: 47px;
      height: 47px;
      border-radius: 50%;
      margin-left: 5px;
      border: 1px solid var(--primary);
      object-fit: cover;
    }
    
    .header-text {
      display: flex;
      flex-direction: column;
    }
    
    header h1 {
      font-size: 18px;
      margin-bottom: 3px;
    }
    
    .status {
      font-size: 14px;
      color: var(--online-status);
      display: flex;
      align-items: center;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--online-status);
      margin-left: 5px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      background: var(--dark);
      color: var(--light-text);
      border: 1px solid var(--border);
      padding: 8px 15px;
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      background: var(--primary);
      transform: translateY(-2px);
    }
    
    .btn i {
      margin-left: 5px;
    }
    
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
    }
    
    .container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      scroll-behavior: smooth;
    }
    
    .msg {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: var(--border-radius);
      max-width: 85%;
      line-height: 1.6;
      position: relative;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
    }
    
    .msg:hover {
      transform: translateY(-3px);
    }
    
    .user {
      background: var(--message-user);
      margin-right: auto;
      border-bottom-right-radius: 5px;
    }
    
    .bot {
      background: var(--message-bot);
      margin-left: auto;
      border-bottom-left-radius: 5px;
    }
    
    .message-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 8px;
      text-align: left;
    }
    
    .input-area {
      padding: 12px;
      background: var(--dark);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      position: relative;
    }
    
    #input {
      flex: 1;
      padding: 12px 18px;
      border-radius: 25px;
      border: none;
      background: var(--darker);
      color: var(--light-text);
      outline: none;
      padding-right: 45px;
      font-family: 'Tajawal', sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    
    #input:focus {
      box-shadow: 0 0 0 2px var(--primary);
    }
    
    .action-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      margin: 0 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 18px;
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      transform: scale(1.1);
    }
    
    #sendBtn {
      background: var(--primary);
    }
    
    #sendBtn:hover {
      background: var(--primary-hover);
    }
    
    #attachBtn {
      background: var(--file-color);
      position: relative;
    }
    
    #attachBtn:hover {
      background: #7c3aed;
    }
    
    #toggleSidebar {
      background: var(--dark);
    }
    
    #toggleSidebar:hover {
      background: var(--primary);
    }
    
    #themeToggle {
      background: var(--dark);
    }
    
    #themeToggle:hover {
      background: var(--primary);
    }
    
    .typing-indicator {
      display: flex;
      padding: 15px;
      margin-left: auto;
      width: fit-content;
      background: var(--message-bot);
      border-radius: var(--border-radius);
    }
    
    .typing-indicator span {
      height: 10px;
      width: 10px;
      background-color: var(--typing-indicator);
      border-radius: 50%;
      margin: 0 3px;
      opacity: 0.4;
    }
    
    .typing-indicator span:nth-child(1) {
      animation: 1s blink infinite 0.3333s;
    }
    
    .typing-indicator span:nth-child(2) {
      animation: 1s blink infinite 0.6666s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation: 1s blink infinite 0.9999s;
    }
    
    @keyframes blink {
      50% {
        opacity: 1;
      }
    }
    
    .file-message {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      max-width: 300px;
      transition: all 0.3s ease;
    }
    
    .file-item:hover {
      transform: translateX(5px);
    }
    
    .file-icon {
      margin-left: 10px;
      font-size: 22px;
      color: var(--file-color);
    }
    
    .file-info {
      flex: 1;
      overflow: hidden;
    }
    
    .file-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }
    
    .file-size {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--border-radius);
      margin-top: 8px;
      box-shadow: var(--box-shadow);
    }
    
    #fileInput {
      display: none;
    }
    
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .preview-item {
      position: relative;
      width: 70px;
      height: 70px;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
    }
    
    .preview-item:hover {
      transform: scale(1.05);
    }
    
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .remove-preview {
      position: absolute;
      top: 3px;
      left: 3px;
      background: var(--danger);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .remove-preview:hover {
      transform: scale(1.2);
    }
    
    .attachments-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: var(--dark);
      padding: 25px;
      border-radius: var(--border-radius);
      width: 350px;
      max-width: 90%;
      border: 1px solid var(--border);
      box-shadow: var(--box-shadow);
    }
    
    .modal h2 {
      margin-bottom: 15px;
      font-size: 20px;
      text-align: center;
      color: var(--primary);
    }
    
    .modal p {
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      gap: 15px;
    }
    
    .api-status {
      position: fixed;
      bottom: 80px;
      left: 15px;
      background: var(--dark);
      padding: 8px 15px;
      border-radius: 25px;
      font-size: 14px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }
    
    .api-status .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--success);
    }
    
    .api-status .status-dot.error {
      background-color: var(--danger);
    }
    
    .emotion-indicator {
      display: flex;
      align-items: center;
      font-size: 13px;
      margin-top: 8px;
      color: #f472b6;
    }
    
    .emotion-indicator i {
      margin-left: 8px;
    }
    
    .attachment-menu {
      position: absolute;
      bottom: 70px;
      right: 70px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      padding: 10px;
      z-index: 100;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 180px;
      box-shadow: var(--box-shadow);
    }
    
    .attachment-menu.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .attachment-option {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .attachment-option:hover {
      background: var(--primary);
    }
    
    .attachment-option i {
      margin-left: 10px;
      font-size: 18px;
    }
    
    .attachment-option span {
      font-size: 15px;
    }
    
    .camera-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--darker);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .camera-modal.show {
      display: flex;
    }
    
    .camera-container {
      width: 95%;
      max-width: 600px;
      height: 80vh;
      max-height: 600px;
      background: var(--dark);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: var(--box-shadow);
    }
    
    .camera-preview {
      flex: 1;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #cameraVideo {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .camera-controls {
      padding: 20px;
      display: flex;
      justify-content: center;
      gap: 25px;
      background: var(--dark);
      border-top: 1px solid var(--border);
    }
    
    .camera-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      color: white;
      transition: all 0.3s ease;
      box-shadow: var(--box-shadow);
    }
    
    .camera-btn:hover {
      transform: scale(1.1);
    }
    
    #captureBtn {
      background: var(--camera-color);
    }
    
    #switchCamera {
      background: var(--accent);
    }
    
    #closeCamera {
      background: var(--dark);
      position: absolute;
      top: 15px;
      left: 15px;
      width: 45px;
      height: 45px;
      font-size: 18px;
    }
    
    #cameraCanvas {
      display: none;
    }
    
    .questions-container {
      margin-top: 20px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
      direction: rtl;
    }
    
    .question-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .question-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-3px);
    }
    
    .question-text {
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--primary);
      font-size: 16px;
    }
    
    .answer-text {
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin-top: 12px;
      display: none;
      line-height: 1.8;
      text-align: right;
      direction: rtl;
    }
    
    .question-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    
    .solve-btn, .explain-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .solve-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }
    
    .explain-btn {
      background: var(--file-color);
    }
    
    .explain-btn:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }
    
    .solve-all-btn, .summarize-btn {
      background: var(--file-color);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-left: 15px;
      transition: all 0.3s ease;
      font-size: 15px;
    }
    
    .solve-all-btn:hover, .summarize-btn:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }
    
    .summarize-btn {
      background: var(--typing-indicator);
    }
    
    .summarize-btn:hover {
      background: #0d9488;
    }
    
    .ocr-result-container {
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-top: 15px;
      box-shadow: var(--box-shadow);
    }
    
    .ocr-header {
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
    }
    
    .ocr-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 15px;
    }
    
    .ocr-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius);
      padding: 15px;
    }
    
    .ocr-section h5 {
      margin-bottom: 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
    }
    
    .text-content, .analysis-content {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.8;
      text-align: right;
      direction: rtl;
    }
    
    .text-content {
      white-space: pre-wrap;
      font-family: 'Tajawal', sans-serif;
    }
    
    /* لوحة التحكم الإدارية */
    .admin-panel {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .admin-panel h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--darker);
      border: 1px solid var(--border);
      color: var(--light-text);
      font-family: 'Tajawal', sans-serif;
    }
    
    /* لوحة الإحصائيات */
    .analytics-dashboard {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 20px;
      border: 1px solid var(--border);
    }
    
    .analytics-dashboard h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .stat-title {
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-weight: bold;
      font-size: 16px;
      color: var(--primary);
    }
    
    /* تأثيرات للوضع النهاري */
    body.light-mode .msg.bot {
      background: var(--light);
      color: var(--darker);
    }
    
    body.light-mode .text-content,
    body.light-mode .analysis-content,
    body.light-mode .answer-text {
      background: rgba(0, 0, 0, 0.05);
    }
    
    body.light-mode .question-item {
      background: rgba(0, 0, 0, 0.03);
    }
    body.light-mode,
body.light-mode .msg,
body.light-mode .question-text,
body.light-mode .answer-text,
body.light-mode .text-content,
body.light-mode .analysis-content,
body.light-mode .ocr-section,
body.light-mode input,
body.light-mode select,
body.light-mode textarea {
  color: #000 !important;
}
    /* تأثيرات الحركة */
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .msg {
      animation: slideIn 0.3s ease forwards;
    }
    
    /* التكيف مع الشاشات الصغيرة */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        transform: translateX(100%);
        z-index: 1000;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        width: 100%;
      }
      
      .attachment-menu {
        right: 15px;
        bottom: 80px;
      }
      
      .camera-container {
        width: 100%;
        height: 100%;
        max-height: none;
        border-radius: 0;
      }
      
      .status {
        font-size: 16px;
      }
      
      .status-dot {
        width: 12px;
        height: 12px;
      }
      
      .msg {
        max-width: 90%;
      }
      
      .action-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      #input {
        padding: 10px 15px;
      }
    }
    
    @media (max-width: 480px) {
      header h1 {
        font-size: 16px;
      }
      
      .btn {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      .msg {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .question-actions {
        flex-direction: column;
        gap: 8px;
      }
      
      .solve-btn, .explain-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

<!-- القائمة الجانبية -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">لوحة التحكم</div>
    <button class="close-sidebar" id="closeSidebar">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div id="apiKeysList">
    <!-- سيتم ملء قائمة مفاتيح API هنا ديناميكيًا -->
  </div>
  
  <div class="admin-panel">
    <h3><i class="fas fa-cog"></i> الإعدادات المتقدمة</h3>
    
    <div class="control-group">
      <label>نموذج الذكاء الاصطناعي:</label>
      <select id="modelSelector" class="form-select">
  <option value="GPT-3.5" selected>GPT-3.5 Turbo</option>
  <option value="GPT-4">GPT-4</option>
  <option value="Claude">Claude 2</option>
</select>
    </div>
    
    <div class="control-group">
      <label>أسلوب الرد:</label>
      <select id="styleSelector" class="form-select">
        <option value="professional">احترافي</option>
        <option value="friendly" selected>ودود</option>
        <option value="academic">أكاديمي</option>
        <option value="creative">إبداعي</option>
      </select>
    </div>
    
    <div class="control-group">
      <label>السياق التاريخي:</label>
      <input type="range" id="contextRange" min="1" max="10" value="7" class="form-select">
    </div>
  </div>
  
  <div id="analyticsDashboard" class="analytics-dashboard">
    <!-- سيتم ملء لوحة الإحصائيات هنا -->
  </div>
</div>

<!-- المحتوى الرئيسي -->
<div class="main-content">
  <header>
    <div class="header-info">
      <img src="https://i.postimg.cc/2j1YD1hn/Whats-App-Image-2025-04-29-at-11-29-46-AM.jpg" alt="المهندس أشرف عادل">
      <div class="header-text">
        <h1>المهندس أشرف عادل</h1>
        <div class="status">
          <span>متصل الآن</span>
          <div class="status-dot"></div>
        </div>
      </div>
    </div>
    <div class="action-buttons">
      <button id="themeToggle" class="action-btn"><i class="fas fa-moon"></i></button>
      <button id="newChatBtn" class="btn"><i class="fas fa-plus"></i> جديد</button>
    </div>
  </header>

  <div class="container" id="chat">
    <!-- الرسائل ستظهر هنا -->
  </div>

  <div class="input-area">
    <button id="toggleSidebar" class="action-btn"><i class="fas fa-key"></i></button>
    <button id="attachBtn" class="action-btn"><i class="fas fa-paperclip"></i></button>
    <div class="attachment-menu" id="attachmentMenu">
      <div class="attachment-option" id="uploadOption">
        <i class="fas fa-upload"></i>
        <span>رفع ملف</span>
      </div>
      <div class="attachment-option" id="cameraOption">
        <i class="fas fa-camera"></i>
        <span>التقاط صورة</span>
      </div>
      <div class="attachment-option" id="driveOption">
        <i class="fab fa-google-drive"></i>
        <span>Google Drive</span>
      </div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt,.ppt,.pptx">
    <input type="text" id="input" placeholder="اكتب رسالتك هنا...">
    <button id="sendBtn" class="action-btn"><i class="fas fa-paper-plane"></i></button>
    <div id="previewContainer" class="preview-container" style="display: none;"></div>
  </div>
</div>

<!-- واجهة الكاميرا -->
<div class="camera-modal" id="cameraModal">
  <div class="camera-container">
    <button id="closeCamera" class="camera-btn"><i class="fas fa-times"></i></button>
    <div class="camera-preview">
      <video id="cameraVideo" autoplay playsinline></video>
      <canvas id="cameraCanvas"></canvas>
    </div>
    <div class="camera-controls">
      <button id="switchCamera" class="camera-btn"><i class="fas fa-sync-alt"></i></button>
      <button id="captureBtn" class="camera-btn"><i class="fas fa-camera"></i></button>
    </div>
  </div>
</div>

<div id="apiStatus" class="api-status" style="display: none;">
  <span class="status-dot"></span>
  <span>API Key 1 نشط</span>
</div>

<div id="newChatModal" class="modal">
  <div class="modal-content">
    <h2><i class="fas fa-comment-medical"></i> بدء محادثة جديدة؟</h2>
    <p>هل أنت متأكد من أنك تريد بدء محادثة جديدة؟ سيتم مسح جميع الرسائل السابقة.</p>
    <div class="modal-buttons">
      <button id="cancelNewChat" class="btn"><i class="fas fa-times"></i> إلغاء</button>
      <button id="confirmNewChat" class="btn btn-primary"><i class="fas fa-check"></i> تأكيد</button>
    </div>
  </div>
</div>

<script>
// ================ تهيئة النظام ================

// مفاتيح API
// مفاتيح API
const API_KEYS = [
  "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",
  "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",
  "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",
  "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"
];
// مفتاح OCR
const OCR_API_KEY = "K84155983788957";
const OCR_API_URL = "https://api.ocr.space/parse/image";

// نماذج الذكاء الاصطناعي
const AI_MODELS = {
  "GPT-3.5": {
    id: "openai/gpt-3.5-turbo",
    maxTokens: 4096,
    cost: 0.002
  },
  "GPT-4": {
    id: "openai/gpt-4",
    maxTokens: 8192,
    cost: 0.06
  },
  "Claude": {
    id: "anthropic/claude-2",
    maxTokens: 100000,
    cost: 0.008
  }
};

// إعدادات Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDEXAMPLE",
  authDomain: "ashraf-adel.firebaseapp.com",
  projectId: "ashraf-adel",
  storageBucket: "ashraf-adel.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};

// متغيرات عالمية
let isTyping = false;
let typingTimeout = null;
let attachments = [];
let currentApiKeyIndex = 0;
let apiKeyErrors = Array(API_KEYS.length).fill(0);
let sidebarOpen = false;
let stream = null;
let currentFacingMode = 'environment';
let currentModel = AI_MODELS["GPT-3.5"];
let currentStyle = "friendly";

// ================ فئات النظام الأساسية ================

class ConversationManager {
  constructor() {
    this.systemPrompt = "أنت المهندس أشرف عادل، مساعد ذكي متخصص في تقديم إجابات دقيقة وعلمية. استخدم لغة عربية واضحة مع بعض اللهجة المصرية الدارجة عند الحاجة. قدم إجابات مفصلة ودقيقة بنسبة 100% مع إمكانية الشرح العلمي عند الطلب. كن دقيقاً في معلوماتك واحترافياً في ردودك. استخدم بعض الإيموجيز المناسبة لتحسين تجربة المستخدم.";
    this.history = [];
    this.summary = "";
    this.maxTokens = 4000;
  }
  
  addMessage(role, content) {
    this.history.push({ role, content, timestamp: Date.now() });
    this.optimizeMemory();
  }
  
  optimizeMemory() {
    let totalTokens = this.history.reduce((sum, msg) => sum + this.countTokens(msg.content), 0);
    
    while (totalTokens > this.maxTokens && this.history.length > 3) {
      const removed = this.history.shift();
      totalTokens -= this.countTokens(removed.content);
      
      if (removed.role === 'user') {
        this.updateSummary(removed.content);
      }
    }
  }
  
  countTokens(text) {
    return Math.ceil(text.length / 4);
  }
  
  updateSummary(newContent) {
    // هذه وظيفة مبسطة - يمكن استبدالها بخوارزمية تلخيص فعلية
    this.summary = newContent.substring(0, 200) + "...";
  }
  
  getContext() {
    return [
      { role: "system", content: this.systemPrompt },
      { role: "assistant", content: `ملخص المحادثة السابقة: ${this.summary}` },
      ...this.history.slice(-6)
    ];
  }
}

class UserManager {
  constructor() {
    this.roles = {
      guest: { features: ['basic_chat'] },
      user: { features: ['full_chat', 'file_upload'] },
      premium: { features: ['advanced_ai', 'document_analysis'] },
      admin: { features: ['all'] }
    };
    this.currentUser = null;
  }
  
  login(userType) {
    this.currentUser = {
      type: userType,
      features: this.roles[userType].features
    };
    this.updateUI();
  }
  
  can(feature) {
    return this.currentUser?.features.includes('all') || 
           this.currentUser?.features.includes(feature);
  }
  
  updateUI() {
    document.querySelectorAll('[data-required-feature]').forEach(el => {
      const requiredFeature = el.dataset.requiredFeature;
      el.style.display = this.can(requiredFeature) ? '' : 'none';
    });
  }
}

class Analytics {
  constructor() {
    this.stats = {
      messagesSent: 0,
      tokensUsed: 0,
      apiCalls: 0,
      errors: 0,
      startTime: Date.now()
    };
  }
  
  logMessage() {
    this.stats.messagesSent++;
  }
  
  logApiCall(tokens) {
    this.stats.apiCalls++;
    this.stats.tokensUsed += tokens;
  }
  
  logError() {
    this.stats.errors++;
  }
  
  getStats() {
    return {
      ...this.stats,
      uptime: Math.floor((Date.now() - this.stats.startTime) / 1000 / 60) + " دقائق",
      avgTokens: this.stats.tokensUsed / (this.stats.apiCalls || 1),
      cost: (this.stats.tokensUsed * 0.000002).toFixed(4) + "$"
    };
  }
  
  
  
  renderDashboard() {
    const stats = this.getStats();

    const data = [
      { label: '📨 الرسائل المرسلة', value: stats.messagesSent, color: '#4cc9f0' },
      { label: '⚙️ عمليات API', value: stats.apiCalls, color: '#4895ef' },
      { label: '📈 متوسط الرموز', value: stats.avgTokens.toFixed(2), color: '#3f37c9' },
      { label: '💸 التكلفة الإجمالية', value: stats.cost, color: '#f72585' },
      { label: '⏱️ وقت التشغيل', value: stats.uptime, color: '#f8961e' },
      { label: '❗ عدد الأخطاء', value: stats.errors, color: '#ef233c' }
    ];

    let html = `
      <div class="analytics-dashboard">
        <h3><i class="fas fa-chart-bar"></i> تقرير الأداء العام</h3>
        <div class="stats-grid">
    `;

    data.forEach(item => {
      html += `
        <div class="stat-card" style="border-left: 5px solid ${item.color};">
          <div class="stat-title" style="color: ${item.color}; font-weight: 600;">${item.label}</div>
          <div class="stat-value" style="font-size: 22px; color: white; margin-top: 8px;">${item.value}</div>
        </div>
      `;
    });

    html += `</div></div>`;
    return html;
  }


}

// ================ تهيئة الكائنات الأساسية ================

const conversation = new ConversationManager();
const userManager = new UserManager();
const analytics = new Analytics();
userManager.login('premium'); // افتراضيًا مستخدم مميز

// ================ الوظائف الأساسية ================

function analyzeSentiment(text) {
  const positiveWords = ['سعيد', 'فرحان', 'مبسوط', 'رائع', 'جميل', 'حب', 'حلو', 'راضي', 'ممتاز', 'حبيبي', 'روعة', 'عظيم'];
  const negativeWords = ['زعلان', 'تعبان', 'حزين', 'مضايق', 'غاضب', 'مش عاجب', 'مزعج', 'سيء', 'تعبان', 'مش حلو', 'مقرف'];
  
  const words = text.toLowerCase().split(/\s+/);
  let positiveCount = 0;
  let negativeCount = 0;
  
  words.forEach(word => {
    if (positiveWords.includes(word)) positiveCount++;
    if (negativeWords.includes(word)) negativeCount++;
  });
  
  if (positiveCount > negativeCount && positiveCount >= 2) {
    return {sentiment: 'positive', emoji: '😊'};
  } else if (negativeCount > positiveCount && negativeCount >= 2) {
    return {sentiment: 'negative', emoji: '😔'};
  }
  return null;
}

async function analyzeImageWithOCR(file) {
  addBotMessage("🔍 جاري تحليل النص من الصورة...", false);
  
  try {
    const ocrText = await tryOcrSpace(file);
    if (ocrText) return ocrText;
    
    const tesseractText = await tryTesseract(file);
    if (tesseractText) return tesseractText;
    
    return "⚠️ لم يتم التعرف على نص واضح في الصورة";
  } catch (error) {
    console.error("OCR Error:", error);
    return "❌ حدث خطأ أثناء محاولة قراءة النص من الصورة";
  }
}

async function tryOcrSpace(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('apikey', OCR_API_KEY);
  formData.append('language', 'ara');
  formData.append('isOverlayRequired', 'false');
  formData.append('detectOrientation', 'true');
  formData.append('scale', 'true');
  
  const response = await fetch(OCR_API_URL, {
    method: "POST",
    body: formData
  });
  
  const data = await response.json();
  
  if (data.IsErroredOnProcessing || !data.ParsedResults?.[0]?.ParsedText) {
    return null;
  }
  
  return formatOCRText(data.ParsedResults[0].ParsedText);
}

async function tryTesseract(file) {
  return new Promise((resolve) => {
    Tesseract.recognize(
      file,
      'ara+eng', 
      {
        logger: m => console.log(m),
        tessedit_pageseg_mode: 6,
        preserve_interword_spaces: 1
      }
    ).then(({ data: { text } }) => {
      resolve(text.trim() ? formatOCRText(text) : null);
    }).catch(() => resolve(null));
  });
}

function formatOCRText(text) {
  if (!text) return text;
  
  return text
    .replace(/([ء-ي])([^ء-ي])/g, '$1$2‏')
    .replace(/([^ء-ي])([ء-ي])/g, '$1‏$2')
    .replace(/(\d+)([ء-ي])/g, '$1‏$2')
    .replace(/([ء-ي])(\d+)/g, '$1‏$2')
    .replace(/\?/g, '؟')
    .replace(/,/g, '،')
    .replace(/\s+/g, ' ')
    .trim();
}

async function analyzeDocument(file) {
  addBotMessage("📄 جاري تحليل المستند، قد يستغرق هذا بضع لحظات...", false);
  
  try {
    let textContent = await readFileAsText(file);
    
    const analysis = {
      wordCount: textContent.split(/\s+/).length,
      lines: textContent.split('\n').length,
      sentiment: analyzeSentiment(textContent)
    };
    
    return {
      summary: `الملف يحتوي على ${analysis.wordCount} كلمة و${analysis.lines} سطر.`,
      content: textContent.substring(0, 1000) + (textContent.length > 1000 ? "..." : "")
    };
  } catch (error) {
    console.error("Document analysis error:", error);
    return {
      summary: "❌ تعذر تحليل المستند",
      content: ""
    };
  }
}

function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = (e) => reject(e);
    reader.readAsText(file);
  });
}

function extractQuestions(text) {
  const questionPatterns = [
    /\d+[\.\)]\s*(.+?)(?=\n\d+[\.\)]|$)/g,
    /-\s*(.+?\?)/g,
    /\n\s*(.+?\?)/g,
    /سؤال:\s*(.+?)(?=\n|$)/gi,
    /(.+?\?)/g
  ];
  
  const questions = new Set();
  
  questionPatterns.forEach(pattern => {
    let match;
    while ((match = pattern.exec(text)) !== null) {
      const question = match[1].trim();
      if (question.length > 10 && !questions.has(question)) {
        questions.add(question);
      }
    }
  });
  
  return Array.from(questions);
}

function containsQuestions(text) {
  const questionIndicators = ['؟', '?', 'سؤال', 'ما هو', 'ما هي', 'كيف', 'لماذا', 'أين', 'متى', 'من'];
  return questionIndicators.some(indicator => text.includes(indicator));
}

function solveQuestions(text) {
  const questions = extractQuestions(text);
  
  if (questions.length === 0) {
    if (containsQuestions(text)) {
      return `<div class="questions-container">
        <h4>تم العثور على سؤال واحد:</h4>
        <div class="question-item" data-index="0">
          <div class="question-text">السؤال: ${text}</div>
          <div class="answer-text" id="answer-0"></div>
          <div class="question-actions">
            <button class="solve-btn" onclick="solveSingleQuestion(0)">
              <i class="fas fa-lightbulb"></i> حل السؤال
            </button>
            <button class="explain-btn" onclick="explainAnswer(0)">
              <i class="fas fa-info-circle"></i> شرح الإجابة
            </button>
          </div>
        </div>
        <button class="summarize-btn" onclick="summarizeAnswers()">
          <i class="fas fa-file-alt"></i> تلخيص الإجابات
        </button>
      </div>`;
    } else {
      return `<div class="questions-container">
        <h4>⚠️ لم يتم العثور على أسئلة واضحة في النص</h4>
        <p>${text}</p>
      </div>`;
    }
  }
  
  let questionsHTML = `<div class="questions-container">
    <h4>تم العثور على ${questions.length} سؤال:</h4>`;
  
  questions.forEach((question, index) => {
    questionsHTML += `
      <div class="question-item" data-index="${index}">
        <div class="question-text">السؤال ${index + 1}: ${question}</div>
        <div class="answer-text" id="answer-${index}"></div>
        <div class="question-actions">
          <button class="solve-btn" onclick="solveSingleQuestion(${index})">
            <i class="fas fa-lightbulb"></i> حل السؤال
          </button>
          <button class="explain-btn" onclick="explainAnswer(${index})">
            <i class="fas fa-info-circle"></i> شرح الإجابة
          </button>
        </div>
      </div>`;
  });
  
  questionsHTML += `
    <button class="solve-all-btn" onclick="solveAllQuestions()">
      <i class="fas fa-bolt"></i> حل جميع الأسئلة
    </button>
    <button class="summarize-btn" onclick="summarizeAnswers()">
      <i class="fas fa-file-alt"></i> تلخيص الإجابات
    </button>
  </div>`;
  
  return questionsHTML;
}

async function solveSingleQuestion(index) {
  const questionElement = document.querySelector(`.question-item[data-index="${index}"] .question-text`);
  const answerElement = document.querySelector(`#answer-${index}`);
  
  if (!questionElement || !answerElement) return;
  
  const question = questionElement.textContent.replace(`السؤال ${index + 1}: `, '').trim();
  
  answerElement.innerHTML = "<i class='fas fa-spinner fa-spin'></i> جاري البحث عن الإجابة...";
  answerElement.style.display = "block";
  
  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: currentModel.id,
        messages: [
          ...conversation.getContext(),
          {
            role: "user",
            content: question
          }
        ],
        temperature: 0.7,
        max_tokens: 500
      })
    });
    
    const data = await response.json();
    if (data.choices && data.choices[0]?.message?.content) {
      answerElement.innerHTML = "";
      typeText(data.choices[0].message.content.trim(), answerElement);
      
      conversation.addMessage("user", question);
      conversation.addMessage("assistant", data.choices[0].message.content.trim());
      
      analytics.logApiCall(data.usage?.total_tokens || 100);
    } else {
      answerElement.innerHTML = "❌ تعذر العثور على إجابة لهذا السؤال.";
    }
  } catch (error) {
    console.error("Error:", error);
    answerElement.innerHTML = "❌ حدث خطأ أثناء محاولة حل السؤال.";
  }
}

async function solveAllQuestions() {
  const questions = document.querySelectorAll('.question-item');
  for (let i = 0; i < questions.length; i++) {
    await solveSingleQuestion(i);
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
}

async function explainAnswer(index) {
  const questionElement = document.querySelector(`.question-item[data-index="${index}"] .question-text`);
  const answerElement = document.querySelector(`#answer-${index}`);
  
  if (!questionElement || !answerElement) return;
  
  const question = questionElement.textContent.replace(`السؤال ${index + 1}: `, '').trim();
  
  answerElement.innerHTML = " جاري تحضير شرح مفصل...";
  answerElement.style.display = "block";
  
  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: currentModel.id,
        messages: [
          ...conversation.getContext(),
          {
            role: "user",
            content: `اشرح لي الإجابة على هذا السؤال بطريقة مفصلة وسهلة الفهم: ${question}`
          }
        ],
        temperature: 0.7,
        max_tokens: 800
      })
    });
    
    const data = await response.json();
    if (data.choices && data.choices[0]?.message?.content) {
      answerElement.innerHTML = "";
      typeText(data.choices[0].message.content.trim(), answerElement);
      
      analytics.logApiCall(data.usage?.total_tokens || 150);
    } else {
      answerElement.innerHTML = "❌ تعذر تحضير شرح لهذا السؤال.";
    }
  } catch (error) {
    console.error("Error:", error);
    answerElement.innerHTML = "❌ حدث خطأ أثناء محاولة شرح السؤال.";
  }
}

async function summarizeAnswers() {
  const questions = document.querySelectorAll('.question-item');
  if (questions.length === 0) return;
  
  const answers = [];
  questions.forEach((_, index) => {
    const answerElement = document.querySelector(`#answer-${index}`);
    if (answerElement && answerElement.textContent.trim()) {
      answers.push(answerElement.textContent.trim());
    }
  });
  
  if (answers.length === 0) {
    addBotMessage("⚠️ لم يتم حل أي أسئلة بعد لتلخيصها", false);
    return;
  }
  
  addBotMessage(" جاري تحضير ملخص للإجابات...", false);
  
  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: currentModel.id,
        messages: [
          ...conversation.getContext(),
          {
            role: "user",
            content: `لدي مجموعة من الإجابات على أسئلة مختلفة. أريد منك تلخيصها في نقاط واضحة:\n\n${answers.join('\n\n')}`
          }
        ],
        temperature: 0.5,
        max_tokens: 1000
      })
    });
    
    const data = await response.json();
    if (data.choices && data.choices[0]?.message?.content) {
      const summaryDiv = document.createElement("div");
      summaryDiv.className = "msg bot";
      summaryDiv.innerHTML = `<strong>ملخص الإجابات:</strong>\n\n`;
      chat.appendChild(summaryDiv);
      typeText(data.choices[0].message.content.trim(), summaryDiv);
      
      analytics.logApiCall(data.usage?.total_tokens || 200);
    } else {
      addBotMessage("❌ تعذر تحضير ملخص للإجابات.", false);
    }
  } catch (error) {
    console.error("Error:", error);
    addBotMessage("❌ حدث خطأ أثناء محاولة تلخيص الإجابات.", false);
  }
}

function displayOCRResults(text, analysis) {
  const div = document.createElement("div");
  div.className = "msg bot";
  
  const formattedText = formatOCRText(text);
  
  div.innerHTML = `
    <div class="ocr-result-container">
      <div class="ocr-header">
        <i class="fas fa-file-alt"></i>
        <h4>نتائج تحليل الصورة</h4>
      </div>
      <div class="ocr-content">
        <div class="ocr-section">
          <h5><i class="fas fa-text-height"></i> النص المستخرج:</h5>
          <div class="text-content">${formattedText || "لا يوجد نص قابل للقراءة"}</div>
        </div>
        <div class="ocr-section">
          <h5><i class="fas fa-brain"></i> التحليل الذكي:</h5>
          <div class="analysis-content">${analysis}</div>
        </div>
      </div>
    </div>
  `;
  
  const timeDiv = document.createElement("div");
  timeDiv.className = "message-time";
  timeDiv.textContent = getCurrentTime();
  div.appendChild(timeDiv);
  
  chat.appendChild(div);
  scrollToBottom();
}

function addUserMessage(text, files = []) {
  const div = document.createElement("div");
  div.className = "msg user";
  
  if (text) {
    const textDiv = document.createElement("div");
    textDiv.textContent = text;
    div.appendChild(textDiv);
    
    const sentiment = analyzeSentiment(text);
    if (sentiment) {
      const emotionDiv = document.createElement("div");
      emotionDiv.className = "emotion-indicator";
      const icon = sentiment.sentiment === 'positive' ? 'fa-smile' : 'fa-frown';
      emotionDiv.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${sentiment.sentiment === 'positive' ? 'مشاعر إيجابية' : 'مشاعر سلبية'}</span>
        ${sentiment.emoji}
      `;
      div.appendChild(emotionDiv);
    }
  }
  
  if (files.length > 0) {
    const attachmentsDiv = document.createElement("div");
    attachmentsDiv.className = "attachments-container";
    
    files.forEach(file => {
      if (file.type.startsWith('image/')) {
        const imgDiv = document.createElement("div");
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.className = "image-preview";
        imgDiv.appendChild(img);
        attachmentsDiv.appendChild(imgDiv);
      } else {
        const fileDiv = document.createElement("div");
        fileDiv.className = "file-item";
        
        const icon = document.createElement("i");
        icon.className = "file-icon " + getFileIcon(file.type);
        
        const infoDiv = document.createElement("div");
        infoDiv.className = "file-info";
        
        const nameDiv = document.createElement("div");
        nameDiv.className = "file-name";
        nameDiv.textContent = file.name;
        
        const sizeDiv = document.createElement("div");
        sizeDiv.className = "file-size";
        sizeDiv.textContent = formatFileSize(file.size);
        
        infoDiv.appendChild(nameDiv);
        infoDiv.appendChild(sizeDiv);
        
        fileDiv.appendChild(icon);
        fileDiv.appendChild(infoDiv);
        attachmentsDiv.appendChild(fileDiv);
      }
    });
    
    div.appendChild(attachmentsDiv);
  }
  
  const timeDiv = document.createElement("div");
  timeDiv.className = "message-time";
  timeDiv.textContent = getCurrentTime();
  div.appendChild(timeDiv);
  
  chat.appendChild(div);
  scrollToBottom();
  
  if (text) {
    conversation.addMessage("user", text);
  }
  
  analytics.logMessage();
}

function addBotMessage(text, typingEffect = true) {
  if (typingEffect) {
    const typingDiv = document.createElement("div");
    typingDiv.className = "typing-indicator";
    typingDiv.innerHTML = `
      <span></span>
      <span></span>
      <span></span>
    `;
    chat.appendChild(typingDiv);
    scrollToBottom();
    
    setTimeout(() => {
      typingDiv.remove();
      
      const div = document.createElement("div");
      div.className = "msg bot";
      
      chat.appendChild(div);
      
      typeText(text, div);
    }, 1000);
  } else {
    const div = document.createElement("div");
    div.className = "msg bot";
    
    if (text.startsWith('<div') || text.startsWith('<h4')) {
      div.innerHTML = text;
    } else {
      chat.appendChild(div);
      typeText(text, div);
    }
  }
  
  if (!text.startsWith('<div') && !text.startsWith('<h4')) {
    conversation.addMessage("assistant", text);
  }
  
  analytics.logMessage();
}

function typeText(text, element) {
  isTyping = true;
  let i = 0;
  
  function type() {
    if (i < text.length) {
      element.innerHTML = element.innerHTML + text.charAt(i);
      i++;
      scrollToBottom();
      
      const speed = Math.floor(Math.random() * 30) + 20;
      typingTimeout = setTimeout(type, speed);
    } else {
      isTyping = false;
      
      if (!element.querySelector('.message-time')) {
        const timeDiv = document.createElement("div");
        timeDiv.className = "message-time";
        timeDiv.textContent = getCurrentTime();
        element.appendChild(timeDiv);
      }
    }
  }
  
  type();
}

function getCurrentTime() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  return `${hours}:${minutes}`;
}

function scrollToBottom() {
  chat.scrollTop = chat.scrollHeight;
}

function switchApiKey() {
  const currentKeyElement = document.querySelector(`.api-key-item[data-index="${currentApiKeyIndex}"]`);
  if (currentKeyElement) {
    currentKeyElement.classList.remove('active');
    if (apiKeyErrors[currentApiKeyIndex] >= 3) {
      currentKeyElement.classList.add('error');
    }
  }
  
  let newKeyIndex = -1;
  for (let i = 0; i < API_KEYS.length; i++) {
    if (apiKeyErrors[i] < 3) {
      newKeyIndex = i;
      break;
    }
  }
  
  if (newKeyIndex === -1) {
    apiKeyErrors = Array(API_KEYS.length).fill(0);
    newKeyIndex = 0;
  }
  
  currentApiKeyIndex = newKeyIndex;
  
  const newKeyElement = document.querySelector(`.api-key-item[data-index="${currentApiKeyIndex}"]`);
  if (newKeyElement) {
    newKeyElement.classList.add('active');
    newKeyElement.classList.remove('error');
  }
  
  updateApiStatus();
}

function updateApiStatus() {
  apiStatus.style.display = 'flex';
  apiStatus.querySelector('span:last-child').textContent = `API Key ${currentApiKeyIndex + 1} نشط`;
  
  setTimeout(() => {
    apiStatus.style.display = 'none';
  }, 3000);
}

function createApiKeysList() {
  apiKeysList.innerHTML = '';
  
  API_KEYS.forEach((key, index) => {
    const keyElement = document.createElement('div');
    keyElement.className = `api-key-item ${index === currentApiKeyIndex ? 'active' : ''}`;
    keyElement.dataset.index = index;
    
    const keyInfo = document.createElement('div');
    keyInfo.className = 'api-key-info';
    
    const keyNumber = document.createElement('div');
    keyNumber.className = 'api-key-number';
    keyNumber.textContent = `مفتاح ${index + 1}`;
    
    const keyStatus = document.createElement('div');
    keyStatus.className = `api-key-status ${apiKeyErrors[index] >= 3 ? 'error' : ''}`;
    keyStatus.textContent = apiKeyErrors[index] >= 3 ? 'معطل' : 'نشط';
    
    keyInfo.appendChild(keyNumber);
    keyInfo.appendChild(keyStatus);
    
    const keyValue = document.createElement('div');
    keyValue.className = 'api-key-value';
    keyValue.textContent = `${key.substring(0, 10)}...${key.substring(key.length - 10)}`;
    
    keyElement.appendChild(keyInfo);
    keyElement.appendChild(keyValue);
    
    keyElement.addEventListener('click', () => {
      if (index === currentApiKeyIndex) return;
      
      document.querySelector('.api-key-item.active').classList.remove('active');
      
      currentApiKeyIndex = index;
      keyElement.classList.add('active');
      keyElement.classList.remove('error');
      
      updateApiStatus();
      addBotMessage(`تم التبديل إلى مفتاح API رقم ${index + 1}`, false);
    });
    
    apiKeysList.appendChild(keyElement);
  });
  
  // تحديث لوحة التحكم
  document.getElementById('analyticsDashboard').innerHTML = analytics.renderDashboard();
}

function addRandomEmojis(text) {
  if (Math.random() < 0.3) {
    const emojis = ['✨', '💡', '👍', '👌', '🎓', '🤖', '🌱', '📚', '📱', '👨‍💻'];
    return text + ' ' + emojis[Math.floor(Math.random() * emojis.length)];
  }
  return text;
}

const predefinedResponses = {
  "انت مين": "أنا مساعدك الذكي الذي صممه المهندس أشرف عادل. أساعدك في الحصول على معلومات دقيقة ومفيدة في مختلف المجالات. 💡",
  "مين صممك": "صممني المهندس أشرف عادل، وهو مهندس ومبرمج متميز من طنطا، مصر. لديه خبرة واسعة في مجال البرمجة والذكاء الاصطناعي. 👨‍💻",
  "مين صنعك": "المصمم والمطور هو المهندس أشرف عادل، خريج كلية الهندسة الزراعية بطنطا، ومتخصص في تطوير أنظمة الذكاء الاصطناعي. 🌱",
  "مين اشرف عادل ده": "المهندس أشرف عادل هو مبرمج ومطور هذا النظام. حاصل على بكالوريوس الهندسة الزراعية من جامعة طنطا، وله خبرة في تطوير تطبيقات الذكاء الاصطناعي وتعلم الآلة. 🎓",
  "تعرف ايه عنه": "أعرف أنه مهندس زراعي متخصص في البرمجة، من محافظة الغربية بمصر. لديه مهارات متقدمة في تطوير أنظمة الذكاء الاصطناعي والتعلم الآلي. 🤖",
  "اشرف بيحب ايه": "المهندس أشرف عادل لديه شغف كبير بالبرمجة وتطوير الأنظمة الذكية. كما يهتم بمجال الزراعة الذكية وتطبيق التكنولوجيا في المجال الزراعي. 🌾",
  "اشرف في كلية ايه": "المهندس أشرف عادل تخرج من كلية الهندسة الزراعية بجامعة طنطا، وهو متخصص في دمج التقنيات الحديثة مع العلوم الزراعية. 📚",
  "هو ساكن فين": "المهندس أشرف عادل مقيم في محافظة الغربية بجمهورية مصر العربية. يمكنك التواصل معه على الرقم: 01019789926 إذا كان لديك استفسارات تقنية. 📱",
  "انا اشرف عادل بقا": "مرحباً بك يا مهندس! شرف كبير لي أن أتحدث معك مباشرة. كيف يمكنني مساعدتك اليوم؟ 😊",
  "مرحبا": "أهلاً وسهلاً بك، كيف يمكنني مساعدتك اليوم؟ 👋",
  "اهلا": "مرحباً بك، تفضل بطرح استفسارك أو سؤالك. 💭",
  "صباح الخير": "صباح الخير، كيف يمكنني مساعدتك اليوم؟ ☀️",
  "مساء الخير": "مساء الخير، تفضل بطرح سؤالك أو استفسارك. 🌙",
  "شكرا": "العفو، لا شكر على واجب. إذا كان لديك أي استفسارات أخرى، أنا هنا لمساعدتك. 🙏",
  "تمام": "حسناً، إذا احتجت أي مساعدة أخرى فلا تتردد في السؤال. 👍",
  "كيف حالك": "بخير الحمد لله، شكراً لسؤالك. كيف يمكنني مساعدتك اليوم؟ 😊",
  "السلام عليكم": "وعليكم السلام ورحمة الله وبركاته، كيف يمكنني مساعدتك؟ 🤲",
  "باي": "مع السلامة، لا تتردد في العودة إذا كان لديك أي استفسارات أخرى. 👋",
  "مع السلامة": "إلى اللقاء، كان حديثك ممتعاً. تواصل معنا مجدداً إذا احتجت أي مساعدة. 🌟",
  "بحبك": "شكراً لك، أنا هنا لمساعدتك في أي وقت. ❤️",
  "انت رائع": "شكراً لك، أنا أحاول دائماً تقديم الأفضل. إذا كان لديك أي استفسار، أنا هنا لمساعدتك. ✨",
  "مشكور": "العفو، هذا واجبي. لا تتردد في السؤال عن أي شيء آخر. 🙏",
  "الله يخليك": "الله يخليك ويحفظك، شكراً لك. 🤲",
  "ربنا معاك": "آمين، وإياك. شكراً لك. 🙏"
};

async function handleMessage(message) {
  const lowerMessage = message.toLowerCase().trim();
  
  for (const [key, value] of Object.entries(predefinedResponses)) {
    if (lowerMessage.includes(key.toLowerCase())) {
      addBotMessage(value, true);
      return;
    }
  }
  
  await askAI(message);
}

async function askAI(message) {
  if (attachments.length > 0) {
    for (const file of attachments) {
      if (file.type.startsWith('image/')) {
        const ocrText = await analyzeImageWithOCR(file);
        const formattedText = formatOCRText(ocrText);
        
        if (containsQuestions(ocrText)) {
          const questionsHTML = solveQuestions(formattedText);
          displayOCRResults(formattedText, questionsHTML);
        } else {
          const analysis = await askAI(`هذا نص مستخرج من صورة: ${formattedText}`, false);
          displayOCRResults(formattedText, analysis);
        }
      } else if (file.type.includes('text') || file.type.includes('pdf') || file.type.includes('document')) {
        const analysis = await analyzeDocument(file);
        addBotMessage(`تحليل الملف:\n\n${analysis.summary}\n\n${analysis.content}`, false);
      }
    }
    
    clearAttachments();
    return;
  }
  
  try {
    const context = conversation.getContext();
    
    // إضافة أسلوب الرد حسب الإعدادات
    let prompt = message;
    if (currentStyle === "professional") {
      prompt = `باللغة العربية الفصحى وبأسلوب احترافي: ${message}`;
    } else if (currentStyle === "friendly") {
      prompt = `باللغة العربية العامية المصرية وبأسلوب ودود: ${message}`;
    } else if (currentStyle === "academic") {
      prompt = `باللغة العربية الأكاديمية مع الاستشهاد بالمصادر عند الإمكان: ${message}`;
    } else if (currentStyle === "creative") {
      prompt = `باللغة العربية وبأسلوب إبداعي مع استخدام التشبيهات: ${message}`;
    }
    
    context.push({
      role: "user",
      content: prompt
    });
    
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: currentModel.id,
        messages: context,
        temperature: 0.7,
        max_tokens: currentModel.maxTokens / 2
      })
    });
    
    const data = await response.json();
    if (data.choices && data.choices[0]?.message?.content) {
      const botMessage = data.choices[0].message.content.trim();
      const finalMessage = addRandomEmojis(botMessage);
      
      addBotMessage(finalMessage, true);
      
      conversation.addMessage("assistant", finalMessage);
      
      apiKeyErrors[currentApiKeyIndex] = 0;
      
      const keyElement = document.querySelector(`.api-key-item[data-index="${currentApiKeyIndex}"]`);
      if (keyElement) {
        keyElement.classList.remove('error');
        keyElement.querySelector('.api-key-status').textContent = 'نشط';
        keyElement.querySelector('.api-key-status').className = 'api-key-status';
      }
      
      analytics.logApiCall(data.usage?.total_tokens || 100);
    } else {
      addBotMessage("عذراً، لا يمكنني الإجابة الآن. يرجى المحاولة مرة أخرى لاحقاً.", false);
    }
  } catch (error) {
    console.error("Error:", error);
    
    apiKeyErrors[currentApiKeyIndex]++;
    
    const keyElement = document.querySelector(`.api-key-item[data-index="${currentApiKeyIndex}"]`);
    if (keyElement) {
      if (apiKeyErrors[currentApiKeyIndex] >= 3) {
        keyElement.classList.add('error');
        keyElement.querySelector('.api-key-status').textContent = 'معطل';
        keyElement.querySelector('.api-key-status').className = 'api-key-status error';
      }
    }
    
    if (apiKeyErrors[currentApiKeyIndex] >= 3) {
      addBotMessage("تم اكتشاف مشكلة في المفتاح الحالي، جارٍ التبديل إلى مفتاح آخر...", false);
      switchApiKey();
      
      setTimeout(() => askAI(message), 1000);
    } else {
      addBotMessage("عذراً، حدث خطأ أثناء محاولة الإجابة. يرجى المحاولة مرة أخرى.", false);
      
      setTimeout(() => askAI(message), 1000);
    }
    
    analytics.logError();
  }
}

function handleSend() {
  const message = input.value.trim();
  if (message || attachments.length > 0) {
    addUserMessage(message, attachments);
    input.value = "";
    
    if (message) {
      handleMessage(message);
    } else if (attachments.length > 0) {
      askAI("لدي مرفقات أريد تحليلها");
    }
  }
}

function setupNewChat() {
  newChatBtn.addEventListener('click', function() {
    newChatModal.style.display = 'flex';
  });
  
  cancelNewChat.addEventListener('click', function() {
    newChatModal.style.display = 'none';
  });
  
  confirmNewChat.addEventListener('click', function() {
  chat.innerHTML = '';
  newChatModal.style.display = 'none';
  clearAttachments();
  
  conversation = new ConversationManager();
  
  setTimeout(() => {
    addBotMessage("مرحباً من جديد! أنا المهندس أشرف عادل 👨‍💻 كيف يمكنني مساعدتك اليوم؟", false);
  }, 500);
});
  
  window.addEventListener('click', function(event) {
    if (event.target === newChatModal) {
      newChatModal.style.display = 'none';
    }
  });
}

function setupFileAttachments() {
  attachBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    attachmentMenu.classList.toggle('show');
  });
  
  uploadOption.addEventListener('click', function() {
    fileInput.click();
    attachmentMenu.classList.remove('show');
  });
  
  cameraOption.addEventListener('click', function() {
    openCamera();
    attachmentMenu.classList.remove('show');
  });
  
  driveOption.addEventListener('click', function() {
    addBotMessage("ميزة التكامل مع Google Drive قيد التطوير حالياً", false);
    attachmentMenu.classList.remove('show');
  });
  
  fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      Array.from(e.target.files).forEach(file => {
        attachments.push(file);
        addFilePreview(file);
      });
      
      previewContainer.style.display = 'flex';
      fileInput.value = '';
    }
  });
  
  document.addEventListener('click', function() {
    attachmentMenu.classList.remove('show');
  });
}

function openCamera() {
  cameraModal.classList.add('show');
  
  const constraints = {
    video: {
      facingMode: currentFacingMode
    },
    audio: false
  };
  
  navigator.mediaDevices.getUserMedia(constraints)
    .then(function(s) {
      stream = s;
      cameraVideo.srcObject = stream;
    })
    .catch(function(err) {
      console.error("Camera Error:", err);
      addBotMessage("❌ تعذر الوصول إلى الكاميرا. يرجى التحقق من الأذونات.", false);
      closeCameraModal();
    });
}

function switchCameraMode() {
  if (!stream) return;
  
  stream.getTracks().forEach(track => track.stop());
  
  currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
  
  openCamera();
}

function closeCameraModal() {
  cameraModal.classList.remove('show');
  
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
}

function captureImage() {
  const context = cameraCanvas.getContext('2d');
  cameraCanvas.width = cameraVideo.videoWidth;
  cameraCanvas.height = cameraVideo.videoHeight;
  context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
  
  cameraCanvas.toBlob(function(blob) {
    const file = new File([blob], `صورة-${new Date().toISOString()}.jpg`, { type: 'image/jpeg' });
    attachments.push(file);
    addFilePreview(file);
    previewContainer.style.display = 'flex';
    
    closeCameraModal();
    addBotMessage("تم التقاط الصورة بنجاح! يمكنك الآن تحليلها أو إرسالها. 📷", false);
  }, 'image/jpeg', 0.9);
}

function addFilePreview(file) {
  const previewItem = document.createElement('div');
  previewItem.className = 'preview-item';
  
  if (file.type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    previewItem.appendChild(img);
  } else {
    const icon = document.createElement('i');
    icon.className = getFileIcon(file.type) + ' fa-2x';
    previewItem.appendChild(icon);
  }
  
  const removeBtn = document.createElement('div');
  removeBtn.className = 'remove-preview';
  removeBtn.innerHTML = '<i class="fas fa-times"></i>';
  removeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    removeAttachment(file, previewItem);
  });
  
  previewItem.appendChild(removeBtn);
  previewContainer.appendChild(previewItem);
}

function removeAttachment(file, previewElement) {
  attachments = attachments.filter(f => f !== file);
  previewElement.remove();
  
  if (attachments.length === 0) {
    previewContainer.style.display = 'none';
  }
}

function clearAttachments() {
  attachments = [];
  previewContainer.innerHTML = '';
  previewContainer.style.display = 'none';
}

function getFileIcon(fileType) {
  if (fileType.startsWith('image/')) return 'fas fa-image';
  if (fileType.includes('pdf')) return 'fas fa-file-pdf';
  if (fileType.includes('word')) return 'fas fa-file-word';
  if (fileType.includes('excel')) return 'fas fa-file-excel';
  if (fileType.includes('powerpoint')) return 'fas fa-file-powerpoint';
  if (fileType.includes('zip') || fileType.includes('compressed')) return 'fas fa-file-archive';
  if (fileType.includes('text')) return 'fas fa-file-alt';
  return 'fas fa-file';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function setupSidebar() {
  toggleSidebar.addEventListener('click', () => {
    sidebarOpen = !sidebarOpen;
    sidebar.classList.toggle('open', sidebarOpen);
  });
  
  closeSidebar.addEventListener('click', () => {
    sidebarOpen = false;
    sidebar.classList.remove('open');
  });
  
  document.addEventListener('click', (e) => {
    if (sidebarOpen && !sidebar.contains(e.target) && e.target !== toggleSidebar) {
      sidebarOpen = false;
      sidebar.classList.remove('open');
    }
  });
}

function setupThemeToggle() {
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    if (document.body.classList.contains('light-mode')) {
      themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
      themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }
  });
}

function setupModelSelector() {
  modelSelector.addEventListener('change', (e) => {
    const modelName = e.target.value;
    if (AI_MODELS[modelName]) {
      currentModel = AI_MODELS[modelName];
      addBotMessage(`تم التبديل إلى نموذج ${modelName} بنجاح`, false);
    }
  });
}

function setupStyleSelector() {
  styleSelector.addEventListener('change', (e) => {
    currentStyle = e.target.value;
    addBotMessage(`تم تغيير أسلوب الرد إلى ${e.target.options[e.target.selectedIndex].text}`, false);
  });
}

// عناصر DOM
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const newChatBtn = document.getElementById('newChatBtn');
const newChatModal = document.getElementById('newChatModal');
const cancelNewChat = document.getElementById('cancelNewChat');
const confirmNewChat = document.getElementById('confirmNewChat');
const attachBtn = document.getElementById('attachBtn');
const attachmentMenu = document.getElementById('attachmentMenu');
const uploadOption = document.getElementById('uploadOption');
const cameraOption = document.getElementById('cameraOption');
const driveOption = document.getElementById('driveOption');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');
const apiStatus = document.getElementById('apiStatus');
const sidebar = document.getElementById('sidebar');
const closeSidebar = document.getElementById('closeSidebar');
const toggleSidebar = document.getElementById('toggleSidebar');
const apiKeysList = document.getElementById('apiKeysList');
const cameraModal = document.getElementById('cameraModal');
const cameraVideo = document.getElementById('cameraVideo');
const cameraCanvas = document.getElementById('cameraCanvas');
const captureBtn = document.getElementById('captureBtn');
const switchCamera = document.getElementById('switchCamera');
const closeCamera = document.getElementById('closeCamera');
const themeToggle = document.getElementById('themeToggle');
const modelSelector = document.getElementById('modelSelector');
const styleSelector = document.getElementById('styleSelector');

// أحداث لوحة المفاتيح
input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    handleSend();
  }
});

// حدث زر الإرسال
sendBtn.addEventListener("click", handleSend);

// أحداث الكاميرا
captureBtn.addEventListener("click", captureImage);
switchCamera.addEventListener("click", switchCameraMode);
closeCamera.addEventListener("click", closeCameraModal);

// تهيئة الصفحة
window.addEventListener("load", () => {
  setupNewChat();
  setupFileAttachments();
  setupSidebar();
  setupThemeToggle();
  setupModelSelector();
  setupStyleSelector();
  createApiKeysList();

// تحديث لوحة الإحصائيات تلقائياً كل 30 ثانية
setInterval(() => {
  document.getElementById('analyticsDashboard').innerHTML = analytics.renderDashboard();
}, 30000);

  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  
  setTimeout(() => {
    addBotMessage("مرحباً! أنا المهندس أشرف عادل. كيف يمكنني مساعدتك اليوم؟ 😊", false);
  }, 500);
  
  updateApiStatus();
});

// جعل الدوال متاحة عالمياً لاستخدامها في HTML
window.solveSingleQuestion = solveSingleQuestion;
window.solveAllQuestions = solveAllQuestions;
window.explainAnswer = explainAnswer;
window.summarizeAnswers = summarizeAnswers;
</script>

</body>
</html>
